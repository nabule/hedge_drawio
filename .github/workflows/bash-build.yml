name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 登录 DockerHub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build HedgeDoc Image
        run: |
          chmod +x ./build.sh
          # 使用标签名作为镜像 tag
          ./build.sh hedgedoc ${{ github.ref_name }}

      # 推送镜像到 DockerHub（tag 版本 + latest）
      - name: Push to Docker Hub
        run: |
          IMAGE_NAME="nabule/hedgedoc"
          VERSION="${{ github.ref_name }}"
          
          # 推送对应版本的 tag
          docker push "${IMAGE_NAME}:${VERSION}"
          
          # 同时打 latest 标签并推送
          docker tag "${IMAGE_NAME}:${VERSION}" "${IMAGE_NAME}:latest"
          docker push "${IMAGE_NAME}:latest"

      - name: Export and Package
        run: |
          # 镜像名为 nabule/hedgedoc:版本号
          IMAGE_NAME="nabule/hedgedoc:${{ github.ref_name }}"
          mkdir -p release_pkg
          docker save $IMAGE_NAME -o release_pkg/hedgedoc.tar
          cp docker-compose.yml release_pkg/
          cp build.sh release_pkg/deploy.sh
          
          # 创建说明文件
          echo "# HedgeDoc + DrawIO ${{ github.ref_name }} 部署说明" > release_pkg/README.md
          echo "" >> release_pkg/README.md
          echo "## 部署步骤" >> release_pkg/README.md
          echo "1. 加载镜像: docker load -i hedgedoc.tar" >> release_pkg/README.md
          echo "2. 启动服务: docker compose up -d" >> release_pkg/README.md
          
          # 压缩
          cd release_pkg
          tar -cvzf ../hedge_drawio_${{ github.ref_name }}_offline.tar.gz .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: hedge_drawio_${{ github.ref_name }}_offline.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
