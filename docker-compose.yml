# HedgeDoc + DrawIO Docker Compose 配置
# 第七阶段：支持自定义URI访问功能

services:
  # PostgreSQL 数据库 - HedgeDoc 的数据存储
  database:
    image: postgres:13-alpine
    environment:
      POSTGRES_USER: hedgedoc
      POSTGRES_PASSWORD: hedgedoc_password
      POSTGRES_DB: hedgedoc
    volumes:
      # 数据库数据持久化
      - ./data/database:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - hedgedoc-net

  # HedgeDoc 协作 Markdown 编辑器
  hedgedoc:
    # 使用本地编译镜像（包含思维导图功能）
    image: nabule/hedge_drawio:local
    environment:
      # 数据库配置
      CMD_DB_URL: postgres://hedgedoc:hedgedoc_password@database:5432/hedgedoc
      # 域名配置 - 根据实际情况修改
      CMD_DOMAIN: '192.168.2.118'
      CMD_URL_ADDPORT: 'true'
      CMD_PROTOCOL_USESSL: 'false'
      # 允许匿名用户访问
      CMD_ALLOW_ANONYMOUS: 'true'
      CMD_ALLOW_ANONYMOUS_EDITS: 'true'
      # 允许注册
      CMD_ALLOW_EMAIL_REGISTER: 'true'
      # 图片上传配置
      CMD_IMAGE_UPLOAD_TYPE: filesystem
      # 自定义URI功能（第七阶段）
      # 访问不存在的URI时自动创建新文档
      CMD_ALLOW_FREEURL: 'true'
      # 不要求登录即可使用自定义URI创建文档
      CMD_REQUIRE_FREEURL_AUTHENTICATION: 'false'
      # DrawIO 配置
      # DrawIO 端口（URL 将基于 CMD_DOMAIN 自动构建）
      CMD_DRAWIO_PORT: '8180'
      # 导出格式: svg (默认) 或 png
      CMD_DRAWIO_EXPORT_FORMAT: svg
      # 是否保留 DrawIO 编辑器中的主题色 (false 为强制浅色/白色背景，适合深色模式兼容)
      CMD_DRAWIO_KEEP_THEME: 'false'
    volumes:
      # 上传文件持久化（包含图片和 DrawIO 文件）
      # 目录结构:
      #   uploads/           - 普通上传图片和 DrawIO 渲染图片
      #   uploads/drawio/    - DrawIO 原始 XML 文件
      - ./data/uploads:/hedgedoc/public/uploads
    ports:
      - "3000:3000"
    depends_on:
      - database
    restart: unless-stopped
    networks:
      - hedgedoc-net

  # DrawIO 图形编辑器
  drawio:
    image: jgraph/drawio:29.2.7
    ports:
      - "8180:8080"
      - "8443:8443"
    restart: unless-stopped
    networks:
      - hedgedoc-net

networks:
  hedgedoc-net:
    driver: bridge
